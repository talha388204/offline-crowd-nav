<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Crowd Navigation</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root{--bg:#0b1220;--card:#111a2b;--ink:#e6edf6;--muted:#9bb0c9;--accent:#35c98b;--danger:#ff6b6b}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:system-ui;background:linear-gradient(180deg,var(--bg),#0c1222 60%,#0f1527);color:var(--ink);min-height:100vh}
        .app{display:flex;flex-direction:column;min-height:100vh}
        header{background:rgba(11,18,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid #1e2a42;padding:1rem;position:sticky;top:0;z-index:1000}
        .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:1rem}
        .brand{display:flex;align-items:center;gap:.75rem}
        .logo{width:40px;height:40px;background:#13233b;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .brand h1{font-size:1.1rem;font-weight:700}
        .subtitle{font-size:.8rem;color:var(--muted)}
        .user-controls{display:flex;gap:.5rem;align-items:center}
        .user-controls input{background:#0f1a2d;border:1px solid #24314a;border-radius:8px;color:var(--ink);padding:.5rem;width:150px}
        .btn{background:#14243e;border:1px solid #233455;color:var(--ink);padding:.5rem 1rem;border-radius:8px;cursor:pointer;transition:all .2s;font-size:.9rem;display:inline-flex;align-items:center;gap:.5rem}
        .btn:hover{transform:translateY(-1px);border-color:#3b5379}
        .btn.accent{background:#1a3a31;border-color:#2f6c58;color:#d5ffe9}
        .btn.danger{background:#3a1a1a;border-color:#6c2f2f;color:#ffe5e5}
        main{flex:1;display:grid;grid-template-columns:1fr 320px;gap:1rem;padding:1rem;max-width:1200px;margin:0 auto;width:100%}
        #map{height:70vh;min-height:400px;border-radius:12px;border:1px solid #1a2740}
        .sidebar{display:flex;flex-direction:column;gap:1rem}
        .panel{background:var(--card);border:1px solid #1b2a46;border-radius:12px;padding:1rem}
        .panel h3{margin-bottom:1rem;font-size:1rem;color:var(--ink)}
        .button-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
        .button-grid .btn{justify-content:center;padding:.75rem .5rem;font-size:.85rem}
        .stats{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
        .stat{text-align:center;padding:.75rem;background:#0f1a2d;border:1px solid #213353;border-radius:8px}
        .stat-value{font-size:1.1rem;font-weight:bold;color:var(--accent)}
        .stat-label{font-size:.8rem;color:var(--muted);margin-top:.25rem}
        .compass{position:relative;width:120px;height:120px;margin:0 auto;background:#0c172a;border:2px solid #213353;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .compass-needle{position:absolute;width:3px;height:50px;background:var(--accent);transform-origin:bottom center;bottom:50%;border-radius:2px;transition:transform .3s ease}
        .compass-text{position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);font-size:.8rem;color:var(--muted);text-align:center;white-space:nowrap}
        .peer-list{max-height:200px;overflow-y:auto}
        .peer-item{background:#0e1930;border:1px solid #22365a;border-radius:8px;padding:.75rem;margin-bottom:.5rem;cursor:pointer;transition:all .2s}
        .peer-item:hover{background:#12213a;border-color:#2a4066}
        .peer-name{font-weight:bold;margin-bottom:.25rem}
        .peer-info{font-size:.8rem;color:var(--muted)}
        .modal{position:fixed;inset:0;background:rgba(2,6,14,.8);display:none;align-items:center;justify-content:center;padding:1rem;z-index:2000}
        .modal.show{display:flex}
        .modal-content{background:var(--card);border:1px solid #1b2a46;border-radius:12px;padding:1.5rem;max-width:400px;width:100%}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .modal-title{font-size:1.1rem;font-weight:bold}
        .qr-container{text-align:center;padding:1rem;background:#0d182b;border:2px dashed #274167;border-radius:8px;margin:1rem 0}
        #qr-canvas{max-width:100%;height:auto}
        #video{width:100%;border-radius:8px}
        .status-banner{background:#2c1b1b;border-bottom:1px solid #6c2f2f;color:#ffe5e5;padding:.75rem;text-align:center;display:none}
        .status-banner.show{display:block}
        @media (max-width:768px){main{grid-template-columns:1fr}.sidebar{order:-1}#map{height:50vh}.header-content{flex-direction:column;gap:.5rem}.button-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="app">
        <div id="status-banner" class="status-banner"></div>
        <header>
            <div class="header-content">
                <div class="brand">
                    <div class="logo">üß≠</div>
                    <div>
                        <h1>Offline Crowd Navigation</h1>
                        <div class="subtitle">PWA ‚Ä¢ Offline Maps ‚Ä¢ QR Handoff</div>
                    </div>
                </div>
                <div class="user-controls">
                    <input type="text" id="username" placeholder="Your name">
                    <button class="btn" onclick="saveName()">Save</button>
                    <button class="btn" onclick="toggleDemo()">Demo Mode</button>
                </div>
            </div>
        </header>
        <main>
            <div id="map"></div>
            <div class="sidebar">
                <div class="panel">
                    <h3>Quick Actions</h3>
                    <div class="button-grid">
                        <button class="btn accent" onclick="shareLocation()">üìç Share</button>
                        <button class="btn" onclick="scanQR()">üì∑ Scan</button>
                        <button class="btn" onclick="dropBreadcrumb()">üçû Drop</button>
                        <button class="btn" onclick="toggleTrail()">üõ§Ô∏è Trail</button>
                        <button class="btn danger" onclick="sosAlert()">üö® SOS</button>
                        <button class="btn" onclick="clearData()">üóëÔ∏è Clear</button>
                    </div>
                </div>
                <div class="panel">
                    <h3>Navigation Compass</h3>
                    <div class="compass">
                        <div id="compass-needle" class="compass-needle"></div>
                        <div id="compass-text" class="compass-text">No target</div>
                    </div>
                </div>
                <div class="panel">
                    <h3>Status</h3>
                    <div class="stats">
                        <div class="stat"><div id="lat-value" class="stat-value">--</div><div class="stat-label">Latitude</div></div>
                        <div class="stat"><div id="lng-value" class="stat-value">--</div><div class="stat-label">Longitude</div></div>
                        <div class="stat"><div id="accuracy-value" class="stat-value">--</div><div class="stat-label">Accuracy</div></div>
                        <div class="stat"><div id="peer-count" class="stat-value">0</div><div class="stat-label">Peers</div></div>
                    </div>
                </div>
                <div class="panel">
                    <h3>Saved Peers</h3>
                    <div id="peer-list" class="peer-list">
                        <div style="text-align:center;color:var(--muted)">No peers yet. Scan QR to add.</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">Modal</h3>
                <button class="btn" onclick="closeModal()">‚úï</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script>
        // Global state
        const state = {
            map: null,
            userMarker: null,
            userPosition: null,
            trail: null,
            trailCoords: [],
            isTrailRecording: false,
            peers: JSON.parse(localStorage.getItem('peers') || '[]'),
            userName: localStorage.getItem('username') || '',
            demoMode: false,
            targetPeer: null
        };

        // Utility functions
        function showStatus(msg, err = false) {
            const banner = document.getElementById('status-banner');
            banner.textContent = msg;
            banner.className = `status-banner show ${err ? 'error' : ''}`;
            setTimeout(() => banner.classList.remove('show'), 5000);
        }

        function fmt(c) {
            return c ? c.toFixed(5) : '--';
        }

        function calcDist(p1, p2) {
            const R = 6371000;
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLon = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function calcBearing(p1, p2) {
            const dLon = (p2.lng - p1.lng) * Math.PI / 180;
            const lat1 = p1.lat * Math.PI / 180;
            const lat2 = p2.lat * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        // Map initialization
        function initMap() {
            state.map = L.map('map').setView([23.8103, 90.4125], 13);
            L.tileLayer('/images/OpenStreetMap.jpg', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap'
            }).addTo(state.map);

            // Demo mode click handler
            state.map.on('click', function(e) {
                if (state.demoMode) {
                    updatePos({
                        latitude: e.latlng.lat,
                        longitude: e.latlng.lng,
                        accuracy: 10
                    }, true);
                }
            });

            // Load saved trail
            const saved = JSON.parse(localStorage.getItem('trail') || '[]');
            if (saved.length > 0) {
                state.trailCoords = saved;
                state.isTrailRecording = true;
                updateTrail();
            }
        }

        // Position update
        function updatePos(coords, demo = false) {
            state.userPosition = coords;
            
            if (!state.userMarker) {
                state.userMarker = L.marker([coords.latitude, coords.longitude], {
                    title: 'Your Location'
                }).addTo(state.map);
                state.map.setView([coords.latitude, coords.longitude], 16);
            } else {
                state.userMarker.setLatLng([coords.latitude, coords.longitude]);
            }

            if (state.isTrailRecording) {
                state.trailCoords.push([coords.latitude, coords.longitude]);
                updateTrail();
            }

            document.getElementById('lat-value').textContent = fmt(coords.latitude);
            document.getElementById('lng-value').textContent = fmt(coords.longitude);
            document.getElementById('accuracy-value').textContent = demo ? 'Demo' : (coords.accuracy ? Math.round(coords.accuracy) : '--');

            if (state.targetPeer) updateCompass();
        }

        // Trail management
        function updateTrail() {
            if (state.trail) state.map.removeLayer(state.trail);
            if (state.trailCoords.length > 1) {
                state.trail = L.polyline(state.trailCoords, {
                    color: '#35c98b',
                    weight: 3
                }).addTo(state.map);
            }
            localStorage.setItem('trail', JSON.stringify(state.trailCoords));
            document.querySelector('[onclick="toggleTrail()"]').textContent = state.isTrailRecording ? '‚èπÔ∏è Stop' : 'üõ§Ô∏è Trail';
        }

        // Compass update
        function updateCompass() {
            if (!state.userPosition || !state.targetPeer) {
                document.getElementById('compass-text').textContent = 'No target';
                return;
            }

            const userPos = { lat: state.userPosition.latitude, lng: state.userPosition.longitude };
            const peerPos = { lat: state.targetPeer.lat, lng: state.targetPeer.lng };
            const dist = calcDist(userPos, peerPos);
            const bearing = calcBearing(userPos, peerPos);

            document.getElementById('compass-needle').style.transform = `rotate(${bearing}deg)`;
            document.getElementById('compass-text').textContent = `${state.targetPeer.name || 'Peer'} - ${dist < 1000 ? Math.round(dist) + 'm' : (dist / 1000).toFixed(1) + 'km'}`;
        }

        // GPS functionality
        function startGPS() {
            if (!navigator.geolocation) {
                showStatus('GPS not supported', true);
                return;
            }

            showStatus('Requesting location permission...');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updatePos(position.coords);
                    showStatus('Location found!');
                    
                    // Start watching position
                    navigator.geolocation.watchPosition(
                        (pos) => updatePos(pos.coords),
                        (err) => console.warn('GPS watch error:', err),
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                    );
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    showStatus('Location denied. Use Demo Mode to click on map.', true);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
            );
        }

        // Peer management
        function savePeers() {
            localStorage.setItem('peers', JSON.stringify(state.peers));
            renderPeers();
        }

        function renderPeers() {
            const container = document.getElementById('peer-list');
            document.getElementById('peer-count').textContent = state.peers.length;

            if (!state.peers.length) {
                container.innerHTML = '<div style="text-align:center;color:var(--muted)">No peers yet. Scan QR to add.</div>';
                return;
            }

            container.innerHTML = state.peers.map((p, i) => `
                <div class="peer-item" onclick="selectPeer(${i})">
                    <div class="peer-name">${p.name || 'Anonymous'}</div>
                    <div class="peer-info">${fmt(p.lat)}, ${fmt(p.lng)}<br>${new Date(p.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function selectPeer(i) {
            state.targetPeer = state.peers[i];
            updateCompass();
            state.map.setView([state.targetPeer.lat, state.targetPeer.lng], 16);
            
            if (!state.targetPeer.marker) {
                state.targetPeer.marker = L.marker([state.targetPeer.lat, state.targetPeer.lng], {
                    title: state.targetPeer.name || 'Peer'
                }).addTo(state.map);
            }
        }

        function addPeer(data) {
            const idx = state.peers.findIndex(p => p.id === data.id);
            if (idx >= 0) {
                state.peers[idx] = { ...state.peers[idx], ...data };
            } else {
                state.peers.unshift(data);
            }
            savePeers();
            selectPeer(idx >= 0 ? idx : 0);
        }

        // QR Code functions
        function shareLocation() {
            if (!state.userPosition) {
                showStatus('No location available. Enable GPS or use Demo Mode.', true);
                return;
            }

            const data = {
                type: 'location',
                id: Date.now() + '',
                name: state.userName || 'Anonymous',
                lat: state.userPosition.latitude,
                lng: state.userPosition.longitude,
                timestamp: Date.now()
            };

            showModal('Share Location', `
                <div class="qr-container">
                    <canvas id="qr-canvas" width="256" height="256"></canvas>
                </div>
                <p style="text-align:center;color:var(--muted);margin-top:1rem">
                    Others can scan this QR code to get your location.
                </p>
            `);

            // Generate QR code after modal is shown
            setTimeout(() => {
                const canvas = document.getElementById('qr-canvas');
                if (canvas && window.QRCode) {
                    QRCode.toCanvas(canvas, JSON.stringify(data), {
                        width: 256,
                        margin: 2,
                        color: {
                            dark: '#35c98b',
                            light: '#0d182b'
                        }
                    }, (error) => {
                        if (error) {
                            console.error('QR generation error:', error);
                            showStatus('QR code generation failed', true);
                        }
                    });
                } else {
                    showStatus('QR library not loaded', true);
                }
            }, 100);
        }

        function sosAlert() {
            if (!state.userPosition) {
                showStatus('No location for SOS.', true);
                return;
            }

            const data = {
                type: 'sos',
                id: Date.now() + '',
                name: state.userName || 'Anonymous',
                lat: state.userPosition.latitude,
                lng: state.userPosition.longitude,
                timestamp: Date.now()
            };

            showModal('üö® SOS Alert', `
                <div class="qr-container">
                    <canvas id="qr-canvas" width="256" height="256"></canvas>
                </div>
                <p style="text-align:center;color:var(--danger);margin-top:1rem;font-weight:bold">
                    EMERGENCY: Show this QR code for help.
                </p>
            `);

            setTimeout(() => {
                const canvas = document.getElementById('qr-canvas');
                if (canvas && window.QRCode) {
                    QRCode.toCanvas(canvas, JSON.stringify(data), {
                        width: 256,
                        margin: 2,
                        color: {
                            dark: '#ff6b6b',
                            light: '#0d182b'
                        }
                    });
                }
            }, 100);
        }

        function scanQR() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('Camera not available', true);
                return;
            }

            showModal('Scan QR Code', `
                <video id="video" autoplay playsinline style="width:100%;border-radius:8px"></video>
                <p style="text-align:center;color:var(--muted);margin-top:1rem">
                    Point camera at QR code to scan.
                </p>
            `);

            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            }).then(stream => {
                video.srcObject = stream;
                video.play();

                function scan() {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        
                        if (window.jsQR) {
                            const code = jsQR(imgData.data, canvas.width, canvas.height);
                            if (code) {
                                try {
                                    const data = JSON.parse(code.data);
                                    handleQR(data);
                                    stream.getTracks().forEach(t => t.stop());
                                    closeModal();
                                    return;
                                } catch (e) {
                                    console.warn('Invalid QR data:', e);
                                }
                            }
                        }
                    }
                    requestAnimationFrame(scan);
                }
                scan();
            }).catch(err => {
                console.error('Camera error:', err);
                showStatus('Camera access denied', true);
                closeModal();
            });
        }

        function handleQR(data) {
            if (data.type === 'location') {
                addPeer(data);
                showStatus(`Added peer: ${data.name || 'Anonymous'}`);
            } else if (data.type === 'sos') {
                addPeer(data);
                showStatus(`üö® SOS from ${data.name || 'Someone'}!`, true);
                alert(`üö® EMERGENCY ALERT\n\n${data.name || 'Someone'} needs help!\nLocation: ${fmt(data.lat)}, ${fmt(data.lng)}`);
            } else {
                showStatus('Unknown QR code format', true);
            }
        }

        // Modal functions
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        // Button handlers
        function saveName() {
            const name = document.getElementById('username').value.trim();
            state.userName = name;
            localStorage.setItem('username', name);
            showStatus('Name saved!');
        }

        function toggleDemo() {
            state.demoMode = !state.demoMode;
            document.querySelector('[onclick="toggleDemo()"]').textContent = state.demoMode ? 'üéÆ Demo ON' : 'Demo Mode';
            showStatus(state.demoMode ? 'Demo Mode: Click map to set location' : 'Demo mode off');
        }

        function dropBreadcrumb() {
            if (!state.userPosition) {
                showStatus('No location available', true);
                return;
            }
            L.circleMarker([state.userPosition.latitude, state.userPosition.longitude], {
                radius: 6,
                color: '#35c98b',
                fillColor: '#35c98b',
                fillOpacity: 0.8
            }).addTo(state.map);
            showStatus('Breadcrumb dropped');
        }

        function toggleTrail() {
            if (!state.userPosition && !state.isTrailRecording) {
                showStatus('No location available', true);
                return;
            }

            state.isTrailRecording = !state.isTrailRecording;
            
            if (state.isTrailRecording && !state.trailCoords.length && state.userPosition) {
                state.trailCoords.push([state.userPosition.latitude, state.userPosition.longitude]);
            }
            
            updateTrail();
            
            if (!state.isTrailRecording) {
                localStorage.removeItem('trail');
            }
        }

        function clearData() {
            if (confirm('Clear all saved data?')) {
                localStorage.clear();
                state.peers = [];
                state.trailCoords = [];
                state.userName = '';
                if (state.trail) state.map.removeLayer(state.trail);
                renderPeers();
                document.getElementById('username').value = '';
                showStatus('All data cleared');
            }
        }

        // PWA Setup
        function setupPWA() {
            const manifest = {
                name: 'Offline Crowd Navigation',
                short_name: 'CrowdNav',
                start_url: './',
                display: 'standalone',
                background_color: '#0b1220',
                theme_color: '#35c98b',
                icons: [{
                    src: 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="192" height="192">
                            <rect width="100%" height="100%" rx="32" fill="#13233b"/>
                            <text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="110">üß≠</text>
                        </svg>
                    `),
                    sizes: '192x192',
                    type: 'image/svg+xml'
                }]
            };

            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], { type: 'application/json' }));
            document.head.appendChild(link);

            // Service Worker
            if ('serviceWorker' in navigator && window.isSecureContext) {
                const sw = `
                    const CACHE = 'nav-v1';
                    self.addEventListener('install', e => 
                        e.waitUntil(caches.open(CACHE).then(c => 
                            c.addAll([
                                './',
                                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
                                'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
                                'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
                                'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js'
                            ])
                        ))
                    );
                    self.addEventListener('fetch', e => 
                        e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)))
                    );
                `;
                navigator.serviceWorker.register(
                    URL.createObjectURL(new Blob([sw], { type: 'text/javascript' }))
                ).catch(console.warn);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            
            initMap();
            renderPeers();
            document.getElementById('username').value = state.userName;
            setupPWA();
            
            // Auto-start GPS on secure contexts
            if (window.isSecureContext && !state.demoMode) {
                setTimeout(startGPS, 1000);
            } else {
                showStatus('Click Demo Mode and then click on map to set location');
            }
            
            console.log('App initialized successfully');
        });
    </script>
</body>
</html>
