<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Offline Crowd Navigation</title>
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-mE+ZLdE8C7QkEzjn2WciZq8s9PC6Kxv9Tg0Pz2ZKQ1Wkq8HfMZQ5t3gM6XHx7wV5N6V3wA1ZQ8r3Dg==" crossorigin="anonymous" />
  <style>
    :root{--bg:#0b1220;--card:#111a2b;--ink:#e6edf6;--muted:#9bb0c9;--accent:#35c98b;--danger:#ff6b6b}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial;background:linear-gradient(180deg,var(--bg),#0c1222 60%,#0f1527);color:var(--ink);min-height:100vh}
    .app{display:flex;flex-direction:column;min-height:100vh}
    header{background:rgba(11,18,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid #1e2a42;padding:1rem;position:sticky;top:0;z-index:1000}
    .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:1rem}
    .brand{display:flex;align-items:center;gap:.75rem}
    .logo{width:40px;height:40px;background:#13233b;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
    .brand h1{font-size:1.1rem;font-weight:700}
    .subtitle{font-size:.8rem;color:var(--muted)}
    .user-controls{display:flex;gap:.5rem;align-items:center}
    .user-controls input{background:#0f1a2d;border:1px solid #24314a;border-radius:8px;color:var(--ink);padding:.5rem;width:150px}
    .btn{background:#14243e;border:1px solid #233455;color:var(--ink);padding:.5rem 1rem;border-radius:8px;cursor:pointer;transition:all .2s;font-size:.9rem;display:inline-flex;align-items:center;gap:.5rem}
    .btn:hover{transform:translateY(-1px);border-color:#3b5379}
    .btn.accent{background:#1a3a31;border-color:#2f6c58;color:#d5ffe9}
    .btn.danger{background:#3a1a1a;border-color:#6c2f2f;color:#ffe5e5}
    main{flex:1;display:grid;grid-template-columns:1fr 320px;gap:1rem;padding:1rem;max-width:1200px;margin:0 auto;width:100%}
    #map{height:70vh;min-height:420px;border-radius:12px;border:1px solid #1a2740}
    .sidebar{display:flex;flex-direction:column;gap:1rem}
    .panel{background:var(--card);border:1px solid #1b2a46;border-radius:12px;padding:1rem}
    .panel h3{margin-bottom:1rem;font-size:1rem;color:var(--ink)}
    .button-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .button-grid .btn{justify-content:center;padding:.75rem .5rem;font-size:.85rem}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .stat{text-align:center;padding:.75rem;background:#0f1a2d;border:1px solid #213353;border-radius:8px}
    .stat-value{font-size:1.1rem;font-weight:bold;color:var(--accent)}
    .stat-label{font-size:.8rem;color:var(--muted);margin-top:.25rem}
    .compass{position:relative;width:120px;height:120px;margin:0 auto;background:#0c172a;border:2px solid #213353;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .compass-needle{position:absolute;width:3px;height:50px;background:var(--accent);transform-origin:bottom center;bottom:50%;border-radius:2px;transition:transform .15s ease}
    .compass-text{position:absolute;bottom:-30px;left:50%;transform:translateX(-50%);font-size:.8rem;color:var(--muted);text-align:center;white-space:nowrap}
    .peer-list{max-height:220px;overflow-y:auto}
    .peer-item{background:#0e1930;border:1px solid #22365a;border-radius:8px;padding:.75rem;margin-bottom:.5rem;cursor:pointer;transition:all .2s}
    .peer-item:hover{background:#12213a;border-color:#2a4066}
    .peer-name{font-weight:bold;margin-bottom:.25rem}
    .peer-info{font-size:.8rem;color:var(--muted)}
    .modal{position:fixed;inset:0;background:rgba(2,6,14,.8);display:none;align-items:center;justify-content:center;padding:1rem;z-index:2000}
    .modal.show{display:flex}
    .modal-content{background:var(--card);border:1px solid #1b2a46;border-radius:12px;padding:1.5rem;max-width:420px;width:100%}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
    .modal-title{font-size:1.1rem;font-weight:bold}
    .qr-container{text-align:center;padding:1rem;background:#0d182b;border:2px dashed #274167;border-radius:8px;margin:1rem 0}
    #qr-canvas{max-width:100%;height:auto}
    #video{width:100%;border-radius:8px}
    .status-banner{background:#2c1b1b;border-bottom:1px solid #6c2f2f;color:#ffe5e5;padding:.75rem;text-align:center;display:none}
    .status-banner.show{display:block}
    @media (max-width:768px){main{grid-template-columns:1fr}.sidebar{order:-1}#map{height:55vh}.header-content{flex-direction:column;gap:.5rem}.button-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <div id="status-banner" class="status-banner"></div>
    <header>
      <div class="header-content">
        <div class="brand">
          <div class="logo">üß≠</div>
          <div>
            <h1>Offline Crowd Navigation</h1>
            <div class="subtitle">PWA-ready ‚Ä¢ Offline-ish maps ‚Ä¢ QR handoff</div>
          </div>
        </div>
        <div class="user-controls">
          <input type="text" id="username" placeholder="Your name" autocomplete="nickname" />
          <button class="btn" id="saveNameBtn">Save</button>
          <button class="btn" id="demoBtn">Demo Mode</button>
          <button class="btn" id="compassBtn">Enable Compass</button>
        </div>
      </div>
    </header>

    <main>
      <div id="map" role="application" aria-label="Map"></div>
      <div class="sidebar">
        <div class="panel">
          <h3>Quick Actions</h3>
          <div class="button-grid">
            <button class="btn accent" id="shareBtn">üìç Share</button>
            <button class="btn" id="scanBtn">üì∑ Scan</button>
            <button class="btn" id="crumbBtn">üçû Drop</button>
            <button class="btn" id="trailBtn">üõ§Ô∏è Trail</button>
            <button class="btn danger" id="sosBtn">üö® SOS</button>
            <button class="btn" id="clearBtn">üóëÔ∏è Clear</button>
          </div>
        </div>
        <div class="panel">
          <h3>Navigation Compass</h3>
          <div class="compass">
            <div id="compass-needle" class="compass-needle"></div>
            <div id="compass-text" class="compass-text">No target</div>
          </div>
        </div>
        <div class="panel">
          <h3>Status</h3>
          <div class="stats">
            <div class="stat"><div id="lat-value" class="stat-value">--</div><div class="stat-label">Latitude</div></div>
            <div class="stat"><div id="lng-value" class="stat-value">--</div><div class="stat-label">Longitude</div></div>
            <div class="stat"><div id="accuracy-value" class="stat-value">--</div><div class="stat-label">Accuracy</div></div>
            <div class="stat"><div id="speed-value" class="stat-value">--</div><div class="stat-label">Speed</div></div>
            <div class="stat"><div id="heading-value" class="stat-value">--</div><div class="stat-label">Heading</div></div>
            <div class="stat"><div id="peer-count" class="stat-value">0</div><div class="stat-label">Peers</div></div>
          </div>
        </div>
        <div class="panel">
          <h3>Saved Peers</h3>
          <div id="peer-list" class="peer-list"><div style="text-align:center;color:var(--muted)">No peers yet. Scan QR to add.</div></div>
        </div>
      </div>
    </main>
  </div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title" class="modal-title">Modal</h3>
        <button class="btn" id="closeModalBtn">‚úï</button>
      </div>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- libs placed at end; defer to avoid blocking -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-vz6H2yR2s1gXwKV6GgQ0s9yZq9nG1w3pW0j8T3y6wYkC0X9Qk6LwK8aJ4d8x3Z+o9O6D6Vb6Q+5TqQ==" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <script>
    // ========= Global state =========
    const state = {
      map: null,
      userMarker: null,
      userPosition: null,
      trail: null,
      trailCoords: [],
      isTrailRecording: false,
      peers: [],
      userName: '',
      demoMode: false,
      targetPeer: null,
      heading: null,
      watchId: null,
      mediaStream: null,
    };

    // ========= Utilities =========
    const $ = (sel) => document.querySelector(sel);
    const fmt = (n, p=5) => (typeof n === 'number' && isFinite(n)) ? n.toFixed(p) : '--';

    function showStatus(msg, err=false) {
      const banner = $('#status-banner');
      banner.textContent = msg;
      banner.style.background = err ? '#3a1a1a' : '#14243e';
      banner.style.borderBottomColor = err ? '#6c2f2f' : '#233455';
      banner.classList.add('show');
      setTimeout(()=>banner.classList.remove('show'), 5000);
      console[(err?'error':'log')](msg);
    }

    function calcDist(p1, p2) {
      const R = 6371000;
      const dLat = (p2.lat - p1.lat) * Math.PI/180;
      const dLon = (p2.lng - p1.lng) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function calcBearing(p1, p2) {
      const dLon = (p2.lng - p1.lng) * Math.PI/180;
      const lat1 = p1.lat*Math.PI/180, lat2 = p2.lat*Math.PI/180;
      const y = Math.sin(dLon)*Math.cos(lat2);
      const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
      return (Math.atan2(y,x)*180/Math.PI + 360) % 360;
    }

    // ========= Map =========
    function initMap() {
      // Dhaka as initial view
      state.map = L.map('map', { zoomControl: true }).setView([23.8103, 90.4125], 13);
      // Use OSM tiles (online). These will still render from browser HTTP cache if available offline.
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(state.map);

      // Demo click to move
      state.map.on('click', (e)=>{
        if (!state.demoMode) return;
        updatePos({ latitude:e.latlng.lat, longitude:e.latlng.lng, accuracy:10, speed:null, heading:null }, true);
      });

      // Load saved trail
      try {
        const savedTrail = JSON.parse(localStorage.getItem('trail')||'[]');
        if (Array.isArray(savedTrail) && savedTrail.length>0) {
          state.trailCoords = savedTrail;
          state.isTrailRecording = true;
          updateTrail();
        }
      } catch {}
    }

    function updatePos(coords, demo=false) {
      state.userPosition = coords;
      const lat = coords.latitude, lng = coords.longitude;
      if (!state.userMarker) {
        state.userMarker = L.marker([lat, lng], { title:'Your Location' }).addTo(state.map);
        state.map.setView([lat, lng], 16);
      } else {
        state.userMarker.setLatLng([lat, lng]);
      }

      if (state.isTrailRecording) {
        const last = state.trailCoords[state.trailCoords.length-1];
        if (!last || last[0]!==lat || last[1]!==lng) {
          state.trailCoords.push([lat, lng]);
          updateTrail();
        }
      }

      $('#lat-value').textContent = fmt(lat);
      $('#lng-value').textContent = fmt(lng);
      $('#accuracy-value').textContent = demo? 'Demo' : (typeof coords.accuracy==='number'? Math.round(coords.accuracy)+'m' : '--');
      $('#speed-value').textContent = (typeof coords.speed==='number' && isFinite(coords.speed))? (coords.speed.toFixed(1)+' m/s') : '--';
      $('#heading-value').textContent = (typeof coords.heading==='number' && isFinite(coords.heading))? (Math.round(coords.heading)+'¬∞') : (state.heading!=null? Math.round(state.heading)+'¬∞' : '--');

      if (state.targetPeer) updateCompass();
    }

    function updateTrail() {
      if (state.trail) state.map.removeLayer(state.trail);
      if (state.trailCoords.length>1) {
        state.trail = L.polyline(state.trailCoords, { color:'#35c98b', weight:3 }).addTo(state.map);
      }
      localStorage.setItem('trail', JSON.stringify(state.trailCoords));
      $('#trailBtn').textContent = state.isTrailRecording? '‚èπÔ∏è Stop' : 'üõ§Ô∏è Trail';
    }

    // ========= Compass =========
    function updateCompass() {
      if (!state.userPosition || !state.targetPeer) { $('#compass-text').textContent = 'No target'; return; }
      const userPos = { lat: state.userPosition.latitude, lng: state.userPosition.longitude };
      const peerPos = { lat: state.targetPeer.lat, lng: state.targetPeer.lng };
      const dist = calcDist(userPos, peerPos);
      const bearing = calcBearing(userPos, peerPos); // to target (0=N)
      const deviceHeading = (state.heading!=null? state.heading : (state.userPosition.heading!=null? state.userPosition.heading : 0));
      const relative = (bearing - deviceHeading + 360) % 360;
      $('#compass-needle').style.transform = `rotate(${relative}deg)`;
      $('#compass-text').textContent = `${state.targetPeer.name||'Peer'} ‚Ä¢ ${dist<1000? Math.round(dist)+'m' : (dist/1000).toFixed(1)+'km'}`;
    }

    function enableCompass() {
      // iOS requires user gesture + permission
      const handler = (ev)=>{
        const alpha = ev.absolute ? ev.alpha : ev.webkitCompassHeading ? (360-ev.webkitCompassHeading) : ev.alpha; // normalize
        if (typeof alpha === 'number') {
          state.heading = alpha; // 0 = North
          updateCompass();
        }
      };
      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then((res)=>{
          if (res==='granted') window.addEventListener('deviceorientation', handler);
          else showStatus('Compass permission denied', true);
        }).catch(()=> showStatus('Compass not available', true));
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientationabsolute', handler);
        window.addEventListener('deviceorientation', handler);
      } else {
        showStatus('Compass not supported on this device', true);
      }
    }

    // ========= Geolocation =========
    function startGPS() {
      if (!('geolocation' in navigator)) { showStatus('GPS not supported', true); return; }
      showStatus('Requesting location‚Ä¶');
      navigator.geolocation.getCurrentPosition((pos)=>{
        updatePos(pos.coords);
        showStatus('Location acquired');
        if (state.watchId!=null) navigator.geolocation.clearWatch(state.watchId);
        state.watchId = navigator.geolocation.watchPosition((p)=>updatePos(p.coords), (err)=>{
          console.warn('GPS watch error', err); showStatus('GPS watch error', true);
        }, { enableHighAccuracy:true, timeout:10000, maximumAge:60000 });
      }, (err)=>{
        console.error('Geolocation error', err); showStatus('Location denied. Use Demo Mode to click on map.', true);
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:60000 });
    }

    // ========= Peers =========
    function loadPersisted() {
      try { state.peers = JSON.parse(localStorage.getItem('peers')||'[]'); } catch { state.peers = []; }
      state.userName = localStorage.getItem('username')||'';
      $('#username').value = state.userName;
      renderPeers();
    }

    function savePeers() { localStorage.setItem('peers', JSON.stringify(state.peers)); renderPeers(); }

    function renderPeers() {
      const c = $('#peer-list');
      $('#peer-count').textContent = String(state.peers.length);
      if (!state.peers.length) { c.innerHTML = '<div style="text-align:center;color:var(--muted)">No peers yet. Scan QR to add.</div>'; return; }
      c.innerHTML = state.peers.map((p,i)=>`
        <div class="peer-item" data-idx="${i}">
          <div class="peer-name">${p.name||'Anonymous'}</div>
          <div class="peer-info">${fmt(p.lat)}, ${fmt(p.lng)}<br>${new Date(p.timestamp).toLocaleString()}</div>
        </div>
      `).join('');
      c.querySelectorAll('.peer-item').forEach(el=>{
        el.addEventListener('click', ()=> selectPeer(Number(el.dataset.idx)));
      });
    }

    function selectPeer(i) {
      state.targetPeer = state.peers[i];
      updateCompass();
      state.map.setView([state.targetPeer.lat, state.targetPeer.lng], 16);
      if (!state.targetPeer.marker) {
        state.targetPeer.marker = L.marker([state.targetPeer.lat, state.targetPeer.lng], { title: state.targetPeer.name||'Peer' }).addTo(state.map);
      }
    }

    function addPeer(data) {
      const idx = state.peers.findIndex(p=>p.id===data.id);
      if (idx>=0) state.peers[idx] = { ...state.peers[idx], ...data };
      else state.peers.unshift(data);
      savePeers();
      selectPeer(idx>=0? idx : 0);
      showStatus(`Added peer: ${data.name||'Anonymous'}`);
    }

    // ========= QR =========
    function showModal(title, html) {
      $('#modal-title').textContent = title;
      $('#modal-body').innerHTML = html;
      $('#modal').classList.add('show');
      $('#modal').setAttribute('aria-hidden','false');
    }
    function closeModal() {
      $('#modal').classList.remove('show');
      $('#modal').setAttribute('aria-hidden','true');
      // stop camera if running
      if (state.mediaStream) {
        state.mediaStream.getTracks().forEach(t=>t.stop());
        state.mediaStream = null;
      }
    }

    function shareLocation(type='location') {
      if (!state.userPosition) { showStatus('No location available. Enable GPS or use Demo Mode.', true); return; }
      const data = {
        type,
        id: Date.now()+''+Math.floor(Math.random()*1000),
        name: state.userName||'Anonymous',
        lat: state.userPosition.latitude,
        lng: state.userPosition.longitude,
        timestamp: Date.now()
      };
      const title = type==='sos'? 'üö® SOS Alert' : 'Share Location';
      const info = type==='sos' ? '<p style="text-align:center;color:var(--danger);margin-top:1rem;font-weight:bold">EMERGENCY: Show this QR code for help.</p>' : '<p style="text-align:center;color:var(--muted);margin-top:1rem">Others can scan this QR to get your location.</p>';
      showModal(title, `<div class="qr-container"><canvas id="qr-canvas" width="256" height="256"></canvas></div>${info}`);
      setTimeout(()=>{
        const canvas = document.getElementById('qr-canvas');
        if (canvas && window.QRCode) {
          QRCode.toCanvas(canvas, JSON.stringify(data), {
            width:256, margin:2,
            color: { dark: (type==='sos'? '#ff6b6b' : '#35c98b'), light: '#0d182b' }
          }, (err)=>{ if (err) { console.error(err); showStatus('QR generation failed', true); } });
        } else showStatus('QR library not loaded', true);
      }, 50);
    }

    function scanQR() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showStatus('Camera not available', true); return; }
      showModal('Scan QR Code', `<video id="video" autoplay playsinline style="width:100%;border-radius:8px"></video><p style="text-align:center;color:var(--muted);margin-top:1rem">Point camera at QR to scan.</p>`);
      const video = $('#video');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently:true });
      navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }).then(stream=>{
        state.mediaStream = stream;
        video.srcObject = stream; video.play();
        (function loop(){
          if (!$('#modal').classList.contains('show')) return; // stop if modal closed
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            if (window.jsQR) {
              const code = jsQR(img.data, canvas.width, canvas.height);
              if (code && code.data) {
                try { const data = JSON.parse(code.data); handleQR(data); closeModal(); return; } catch(e){ console.warn('Invalid QR', e); }
              }
            }
          }
          requestAnimationFrame(loop);
        })();
      }).catch(err=>{ console.error('Camera error', err); showStatus('Camera access denied', true); closeModal(); });
    }

    function handleQR(data) {
      if (data && (data.type==='location' || data.type==='sos') && typeof data.lat==='number' && typeof data.lng==='number') {
        addPeer(data);
        if (data.type==='sos') alert(`üö® EMERGENCY\n${data.name||'Someone'} needs help!\n${fmt(data.lat)}, ${fmt(data.lng)}`);
      } else showStatus('Unknown QR format', true);
    }

    // ========= Buttons / Actions =========
    function bindUI() {
      $('#saveNameBtn').addEventListener('click', ()=>{ state.userName = $('#username').value.trim(); localStorage.setItem('username', state.userName); showStatus('Name saved'); });
      $('#demoBtn').addEventListener('click', ()=>{ state.demoMode = !state.demoMode; $('#demoBtn').textContent = state.demoMode? 'üéÆ Demo ON' : 'Demo Mode'; showStatus(state.demoMode? 'Demo: click map to set location' : 'Demo off'); });
      $('#compassBtn').addEventListener('click', enableCompass);
      $('#crumbBtn').addEventListener('click', ()=>{
        if (!state.userPosition) { showStatus('No location', true); return; }
        L.circleMarker([state.userPosition.latitude, state.userPosition.longitude], { radius:6, color:'#35c98b', fillColor:'#35c98b', fillOpacity:0.9 }).addTo(state.map);
        showStatus('Breadcrumb dropped');
      });
      $('#trailBtn').addEventListener('click', ()=>{
        if (!state.userPosition && !state.isTrailRecording) { showStatus('No location', true); return; }
        state.isTrailRecording = !state.isTrailRecording;
        if (state.isTrailRecording && !state.trailCoords.length && state.userPosition) state.trailCoords.push([state.userPosition.latitude, state.userPosition.longitude]);
        if (!state.isTrailRecording) { localStorage.removeItem('trail'); }
        updateTrail();
      });
      $('#shareBtn').addEventListener('click', ()=> shareLocation('location'));
      $('#sosBtn').addEventListener('click', ()=> shareLocation('sos'));
      $('#scanBtn').addEventListener('click', scanQR);
      $('#clearBtn').addEventListener('click', ()=>{
        if (confirm('Clear all saved data?')) {
          localStorage.clear();
          state.peers = []; state.trailCoords=[]; state.userName='';
          if (state.trail) state.map.removeLayer(state.trail);
          renderPeers(); $('#username').value=''; showStatus('Cleared');
        }
      });
      $('#closeModalBtn').addEventListener('click', closeModal);
    }

    // ========= PWA (Manifest + optional SW) =========
    function setupManifest() {
      const manifest = {
        name: 'Offline Crowd Navigation',
        short_name: 'CrowdNav',
        start_url: '.',
        display: 'standalone',
        background_color: '#0b1220',
        theme_color: '#35c98b',
        icons: [{
          src: 'data:image/svg+xml;base64,'+ btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192"><rect width="100%" height="100%" rx="32" fill="#13233b"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="110">üß≠</text></svg>`),
          sizes: '192x192', type: 'image/svg+xml'
        }]
      };
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], { type:'application/json' }));
      document.head.appendChild(link);
    }

    function setupServiceWorker() {
      // NOTE: Browsers do NOT allow registering a service worker from a blob/data URL.
      // For full offline support, place a real sw.js next to this file. This function will register it if present.
      if (!('serviceWorker' in navigator) || !window.isSecureContext) return;
      fetch('sw.js', { method:'HEAD' }).then((res)=>{
        if (res.ok) {
          navigator.serviceWorker.register('sw.js').then(()=> console.log('SW registered')).catch((e)=> console.warn('SW reg failed', e));
        } else {
          console.log('sw.js not found ‚Äì running without offline cache');
        }
      }).catch(()=> console.log('No sw.js ‚Äì running without offline cache'));
    }

    // ========= Boot =========
    document.addEventListener('DOMContentLoaded', ()=>{
      try {
        initMap();
        bindUI();
        loadPersisted();
        setupManifest();
        setupServiceWorker();
        if (window.isSecureContext) setTimeout(startGPS, 500); else showStatus('Use HTTPS for GPS & camera', true);
      } catch (e) {
        console.error(e); showStatus('Initialization failed', true);
      }
    });
  </script>
</body>
</html>
