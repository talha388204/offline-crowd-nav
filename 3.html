<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Offline Crowd Navigation</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:sans-serif; background:#0b1220; color:#e6edf6; }
    #map { height:60vh; }
    .btn { padding:8px 12px; margin:4px; border:none; border-radius:6px; cursor:pointer; }
    .accent{background:#35c98b;color:#fff}
    .danger{background:#ff6b6b;color:#fff}
  </style>
</head>
<body>
  <h2>🧭 Offline Crowd Navigation</h2>
  <div>
    <button class="btn accent" id="shareBtn">📍 Share</button>
    <button class="btn" id="scanBtn">📷 Scan</button>
    <button class="btn" id="crumbBtn">🍞 Drop</button>
    <button class="btn" id="trailBtn">🛤️ Trail</button>
    <button class="btn danger" id="sosBtn">🚨 SOS</button>
    <button class="btn" id="clearBtn">🗑️ Clear</button>
  </div>
  <div id="map"></div>
  <div id="peer-list"></div>

  <!-- Modal -->
  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;">
    <div style="background:#111a2b;padding:20px;border-radius:8px;max-width:400px">
      <button id="closeModalBtn">❌</button>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <script>
    let map, userMarker, trailLine;
    let trailCoords = [];
    let peers = JSON.parse(localStorage.getItem("peers")||"[]");

    function initMap(){
      map = L.map("map").setView([23.81,90.41], 13); // ঢাকা default
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom:19,
        attribution:"© OpenStreetMap"
      }).addTo(map);
    }

    function updatePosition(){
      if(!navigator.geolocation){ alert("Geolocation not supported"); return; }
      navigator.geolocation.watchPosition(pos=>{
        const {latitude, longitude} = pos.coords;
        if(!userMarker){
          userMarker = L.marker([latitude,longitude]).addTo(map).bindPopup("You are here");
          map.setView([latitude,longitude],15);
        } else {
          userMarker.setLatLng([latitude,longitude]);
        }
        trailCoords.push([latitude,longitude]);
        if(trailLine) trailLine.setLatLngs(trailCoords);
      }, err=>{
        console.error(err);
      }, {enableHighAccuracy:true});
    }

    function renderPeers(){
      const list=document.getElementById("peer-list");
      list.innerHTML="";
      if(peers.length===0){ list.innerHTML="<p style='color:gray'>No peers yet</p>"; return;}
      peers.forEach(p=>{
        const div=document.createElement("div");
        div.textContent=p.name+" ("+p.lat.toFixed(4)+","+p.lng.toFixed(4)+")";
        list.appendChild(div);
      });
    }

    // === Button actions ===
    document.getElementById("shareBtn").onclick=()=>{
      if(!userMarker){alert("No location yet");return;}
      const {lat,lng}=userMarker.getLatLng();
      const data={name:"Peer",lat,lng};
      const modal=document.getElementById("modal");
      document.getElementById("modal-body").innerHTML="<div id='qrcode'></div>";
      QRCode.toCanvas(document.createElement("canvas"), JSON.stringify(data),(err,canvas)=>{
        if(!err) document.getElementById("qrcode").appendChild(canvas);
      });
      modal.style.display="flex";
    };

    document.getElementById("scanBtn").onclick=()=>{
      alert("QR Scan feature requires camera setup (can be added)");
    };

    document.getElementById("crumbBtn").onclick=()=>{
      if(!userMarker){alert("No location yet");return;}
      const {lat,lng}=userMarker.getLatLng();
      L.circleMarker([lat,lng],{radius:6,color:"yellow"}).addTo(map).bindPopup("Crumb");
    };

    document.getElementById("trailBtn").onclick=()=>{
      if(trailLine){ map.removeLayer(trailLine); trailLine=null; return;}
      trailLine=L.polyline(trailCoords,{color:"lime"}).addTo(map);
    };

    document.getElementById("sosBtn").onclick=()=>{
      if(!userMarker){alert("No location yet");return;}
      const {lat,lng}=userMarker.getLatLng();
      L.marker([lat,lng],{icon:L.divIcon({html:"🚨",className:"",iconSize:[20,20]})}).addTo(map).bindPopup("SOS");
    };

    document.getElementById("clearBtn").onclick=()=>{
      if(trailLine){map.removeLayer(trailLine);trailLine=null;}
      trailCoords=[];
    };

    document.getElementById("closeModalBtn").onclick=()=>{
      document.getElementById("modal").style.display="none";
    };

    // Init
    initMap();
    updatePosition();
    renderPeers();
  </script>
</body>
</html>
